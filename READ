import pandas as pd

# 1. Configuration des variables
COLS_A_IGNORER = ['GST_DATE_CREATION', 'USER_MAJ'] # Ajoute ici les colonnes à ne pas comparer
# On récupère toutes les colonnes sauf celles à ignorer et l'ID de pivot
cols_a_comparer = [c for c in df_dupes_id.columns if c not in COLS_A_IGNORER and c != 'ID_CODE_TIERS_CRM']

list_fusion_auto = []
list_validation = []

# 2. Groupement et filtrage
for tech_id, group in df_dupes_id.groupby('ID_CODE_TIERS_CRM'):
    
    # CONDITION : On ne compare que si TOUTES les colonnes cibles sont NON NULL
    # On vérifie si le groupe actuel contient des valeurs nulles dans les colonnes de comparaison
    if group[cols_a_comparer].notnull().all().all():
        
        # On vérifie si les lignes sont identiques (semblables)
        if len(group[cols_a_comparer].drop_duplicates()) == 1:
            # ✅ SONT SEMBLABLES (et No Null) -> Prêt à fusionner
            list_fusion_auto.append(group.head(1))
        else:
            # ⚠️ NON SEMBLABLES -> Détection des champs de différence
            diff_cols = [col for col in cols_a_comparer if group[col].nunique() > 1]
            
            group_conflit = group.copy()
            group_conflit['CHAMPS_DIFFERENTS'] = ", ".join(diff_cols)
            list_validation.append(group_conflit)
    else:
        # Optionnel : On peut envoyer les groupes avec des NULL en validation aussi 
        # ou les ignorer selon ton besoin métier. Ici, on les marque comme "Incomplets"
        group_incomplet = group.copy()
        group_incomplet['CHAMPS_DIFFERENTS'] = "DONNEES_MANQUANTES (NULL)"
        list_validation.append(group_incomplet)

# 3. Création des DataFrames
df_pret_a_fusionner = pd.concat(list_fusion_auto).reset_index(drop=True) if list_fusion_auto else pd.DataFrame()
df_en_attente_validation = pd.concat(list_validation).reset_index(drop=True) if list_validation else pd.DataFrame()

# --- Affichage ---
print(f"✅ Prêts pour fusion (Complets & Identiques) : {len(df_pret_a_fusionner)}")
print(f"⚠️ À valider (Différences ou Valeurs Nulles) : {len(df_en_attente_validation)}")

if not df_en_attente_validation.empty:
    display(df_en_attente_validation[['ID_CODE_TIERS_CRM', 'CHAMPS_DIFFERENTS'] + cols_a_comparer].head(10))